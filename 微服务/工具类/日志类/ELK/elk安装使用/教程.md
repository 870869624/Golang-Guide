# 1. 安装 Java

ELK 依赖 Java 环境：

```bash
sudo apt update
sudo apt install openjdk-11-jdk  # 推荐 Java 11
java -version  # 验证安装
```

# 2. 安装 Elasticsearch

```bash
# 导入 GPG Key
wget -qO - https://artifacts.elastic.co/GPG-KEY-elasticsearch | sudo apt-key add -

# 添加仓库
echo "deb https://artifacts.elastic.co/packages/7.x/apt stable main" | sudo tee /etc/apt/sources.list.d/elastic-7.x.list

# 安装
sudo apt update
sudo apt install elasticsearch

# 启动服务
sudo systemctl start elasticsearch
sudo systemctl enable elasticsearch
```

验证：

```bash
curl -X GET "localhost:9200"  # 应返回 JSON 格式的集群信息
```

# 3. 安装 Logstash

```bash
sudo apt install logstash

# 创建配置文件
sudo nano /etc/logstash/conf.d/golang-log.conf
```

配置文件内容（适配 Golang 日志）：

```ruby
input {
  file {
    path => "/path/to/your/logs/*.log"  # 日志路径，例如 /var/log/app/11.log
    start_position => "beginning"        # 从文件开头读取
    sincedb_path => "/dev/null"          # 避免记录读取位置（测试用）
  }
}

filter {
  # 根据日志格式定制解析（示例：解析时间戳、日志级别）
  grok {
    match => { "message" => "\[%{TIMESTAMP_ISO8601:timestamp}\] %{LOGLEVEL:level} %{GREEDYDATA:message}" }
  }
  date {
    match => ["timestamp", "ISO8601"]  # 将 timestamp 设为事件时间
  }
}

output {
  elasticsearch {
    hosts => ["http://localhost:9200"]
    index => "golang-logs-%{+YYYY.MM.dd}"  # Elasticsearch 索引名
  }
}
```

启动服务：

```bash
sudo systemctl start logstash
sudo systemctl enable logstash
```

# 4. 安装 Kibana

```bash
sudo apt install kibana

# 修改配置
sudo nano /etc/kibana/kibana.yml
```

关键配置：

```yaml
server.port: 5601
server.host: "0.0.0.0"  # 允许外部访问
elasticsearch.hosts: ["http://localhost:9200"]
```

启动服务：

```bash
sudo systemctl start kibana
sudo systemctl enable kibana
```

# 5.访问 Kibana 并配置

1. 浏览器访问：http://<服务器IP>:5601

2. 创建索引模式：

- 进入 Management > Stack Management > Index Patterns

- 输入 golang-logs-* 作为索引模式

- 选择 @timestamp 作为时间字段

3. 查看日志：

- 进入 Analytics > Discover，选择 golang-logs-* 索引

# 6. 确保 Golang 日志可被解析

- 推荐日志格式：使用结构化日志（如 JSON），便于 Logstash 解析。
示例（Golang 中使用 logrus 库）：

```go
import log "github.com/sirupsen/logrus"

func main() {
  log.SetFormatter(&log.JSONFormatter{})
  log.Info("User logged in")  // 输出: {"level":"info","msg":"User logged in","time":"2023-01-01T12:00:00Z"}
}
```

- Logstash 解析 JSON（若日志为 JSON）：

```ruby
filter {
  json {
    source => "message"  # 直接解析 JSON 字段
  }
}
```

7. 安全与优化

- 防火墙规则：

```bash
sudo ufw allow 9200  # Elasticsearch
sudo ufw allow 5601  # Kibana
```

- 生产环境建议：

    - 使用 Nginx 反向代理 Kibana，添加 HTTPS 和认证。

    - 配置 Elasticsearch 安全功能（如 X-Pack）。

# 常见问题排查

- 日志未采集：

    - 检查 Logstash 配置文件路径和权限。

    - 运行 Logstash 调试模式：

```bash
sudo /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/golang-log.conf --config.reload.automatic --log.level=debug
```

- Kibana 无数据：

    - 在 Kibana Dev Tools 中查询 Elasticsearch 索引：

```json
GET /_cat/indices?v  # 查看是否存在 golang-logs-* 索引
```