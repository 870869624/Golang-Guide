```bash
goctl api swagger --api rest/ngedr.api --dir . --filename doc/ngedr

C:\Users\linrui\Documents\WXWork\1688856424867849\Cache\File\2025-06\goctl.exe rpc protoc ngedr.proto --go_out=. --go-grpc_out=. --zrpc_out=. --style=go_zero -m（生成 rpc 接口）

C:\Users\linrui\Documents\WXWork\1688856424867849\Cache\File\2025-06\goctl.exe rest go -api ./threat_response.api -dir ../../demo（生成 api 接口）

goctl.exe rpc protoc cleansvc.proto `
  --go_out=. `
  --go-grpc_out=. `
  --zrpc_out=. `
  --style=go_zero `
  -m `
  -I=".;F:\protoc\include"
```

# 安管：

```bash
kubectl edit cm agcbb-config -n sdsp 修改配置
```

```bash
更改配置，暴露端口
[root@node01 ~]# kubectl patch svc agcbb -n sdsp -p '{"spec":{"ports":[{"name":"nanomsg","port":15555,"targetPort":15555,"protocol":"TCP"}]}}'
service/agcbb patched (no change)
[root@node01 ~]# kubectl get svc agcbb -n sdsp -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"app":"agcbb"},"name":"agcbb","namespace":"sdsp"},"spec":{"ports":[{"name":"agcbb-for-agah","nodePort":8084,"port":8084,"protocol":"TCP","targetPort":8084}],"selector":{"app":"agcbb"},"sessionAffinity":"None","type":"NodePort"}}
  creationTimestamp: "2025-10-25T11:19:51Z"
  labels:
    app: agcbb
  name: agcbb
  namespace: sdsp
  resourceVersion: "4573595"
  uid: d4657d7d-7fa7-4a8d-aaa7-8d51ad877748
spec:
  clusterIP: 10.43.19.151
  clusterIPs:
  - 10.43.19.151
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: nanomsg
    nodePort: 3835
    port: 15555
    protocol: TCP
    targetPort: 15555
  - name: agcbb-for-agah
    nodePort: 8084
    port: 8084
    protocol: TCP
    targetPort: 8084
  selector:
    app: agcbb
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: {}
[root@node01 ~]# kubectl port-forward svc/agcbb 15555:15555 -n sdsp
Forwarding from 127.0.0.1:15555 -> 15555
Forwarding from [::1]:15555 -> 15555
```

# k8s 服务：

## 镜像：

```bash
k3s ctr image pull docker-hub.cloud.top/aiop/cleansvc-arm64:latest -k -u che_zhilin:Czl@talent123（手动拉取镜像）
```

然后重启下

```bash
kubectl rollout restart deploy cleansvc -n sdsp
```

## 获取服务：

```bash
kubectl get svc -A
```

### 获取 pod

```bash
kubectl get pods -n sdsp
```

```bash
kubectl get services --all-namespaces
```

返回：

```bash
sdsp              agcbb                                      NodePort    10.43.19.151    <none>        15555:3835/TCP,8084:8084/TCP                 62m
sdsp              bff-web                                    NodePort    10.43.154.134   <none>        443:443/TCP                                  9d
sdsp              cleansvc                                   NodePort    10.43.170.23    <none>        8888:7858/TCP,8080:53280/TCP,6080:6080/TCP   9d
sdsp              common                                     ClusterIP   10.43.25.103    <none>        443/TCP,8080/TCP,8081/TCP,4443/TCP           9d
sdsp              logminer                                   ClusterIP   10.43.198.243   <none>        9001/TCP,8081/TCP                            9d
sdsp              mongo                                      NodePort    10.43.155.234   <none>        27017:32017/TCP                              9d
sdsp              monitor                                    ClusterIP   10.43.8.34      <none>        4196/TCP                                     9d
sdsp              nats                                       ClusterIP   10.43.84.92     <none>        4222/TCP                                     9d
```

### 修改配置文件

```bash
kubectl edit cm -n sdsp cleansvc-config
```

### 改完重启服务

最简单、最安全的办法：直接滚动重启 Deployment，让 Kubernetes 帮你重新创建 Pod，名字会换新（cleansvc-xxx-yyy），旧 Pod 会被优雅终止。

```bash
kubectl rollout restart deployment/cleansvc -n sdsp
```

### 获取 cleansvc 的资源清单

```bash
[root@node01 ~]# kubectl -n sdsp get svc cleansvc -o yaml
```

返回:

```bash
[root@node01 ~]# kubectl -n sdsp get svc cleansvc -o yaml
apiVersion: v1
kind: Service
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Service","metadata":{"annotations":{},"labels":{"app":"cleansvc"},"name":"cleansvc","namespace":"sdsp"},"spec":{"ports":[{"name":"http","port":8888,"protocol":"TCP","targetPort":8888},{"name":"rpc","port":8080,"protocol":"TCP","targetPort":8080}],"selector":{"app":"cleansvc"}}}
  creationTimestamp: "2025-10-16T11:56:10Z"
  labels:
    app: cleansvc
  name: cleansvc
  namespace: sdsp
  resourceVersion: "381968"
  uid: 1ec4924c-29ec-4785-9d5b-39242fe9430f
spec:
  clusterIP: 10.43.170.23
  clusterIPs:
  - 10.43.170.23
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: http
    nodePort: 7858
    port: 8888
    protocol: TCP
    targetPort: 8888
  - name: rpc
    nodePort: 53280
    port: 8080
    protocol: TCP
    targetPort: 8080
  - name: novnc
    nodePort: 6080
    port: 6080
    protocol: TCP
    targetPort: 6080
  selector:
    app: cleansvc
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: {}
```

### 查看日志：

```bash
kubectl logs -f agcbb-7787c8dcb7-24r82 -n sdsp
```

## 获取容器：kubectl -n sdsp get pod

```bash
kubectl get pods
```

```bash
kubectl get svc -n sdsp
```

```bash
kubuctl get svc -n topsec-topngdlp
```

### 获取 mongo 服务：

```bash
kubectl get pods --all-namespaces | grep mongo
```

### 获取索引：

```bash
kubectl exec -it -n topsec-topngdlp deployments/mongodb -- sh -c 'mongo -uroot -pTopsecCdu_1130 --authenticationDatabase admin --eval "
db.adminCommand({listDatabases:1}).databases.forEach(function(database) {
    db = db.getSiblingDB(database.name);
    if(database.name != \"asset\") {
     return;
    }
    db.getCollectionNames().forEach(function(collection) {
        var stats = db[collection].stats();
        print(database.name + \".\" + collection +
              \" - 数据大小: \" + Math.round(stats.storageSize / 1024 / 1024) + \"MB, \" +
              \"索引大小: \" + Math.round(stats.totalIndexSize / 1024 / 1024) + \"MB\");
    });
});
"'
```

## 进入 pods：

```bash
kubectl exec -it virt-launcher-clean-node01-hv4sn -- /bin/bash

kubectl exec -it cleansvc-7dc5b6d855-rrfzc -n sdsp -c cleansvc -- sh
```

```bash
kubectl exec -it -n sdsp  cleansvc-5858f89d9d-8txkl   -- /bin/bash
```

### 进入 pods 后想要本地调取链接

```bash
[root@node01 ~]# kubectl exec -it cleansvc-784d4d9448-n2pzs -n sdsp -c cleansvc -- sh
/home/topsec # curl http://0.0.0.0:8888/api/v2/cleansvc/report/systemStatusView
sh: curl: not found

//或者

[root@node01 ~]# kubectl exec -it cleansvc-784d4d9448-n2pzs -n sdsp -c cleansvc -- sh
/home/topsec # wget -qO- http://0.0.0.0:8888/api/v2/cleansvc/report/systemStatusView
{"total":1,"message":"OK","data":[{"View":{"@code":"SystemStatus_View_1.00","@description":"系统状态视图","@id":"","@version":"1.00","System":{"@type":"VIRTUAL_SER_SOFTWARE","Nodes":{"Node":{"@ip":"","@mac":"3A:6E:D1:05:95:8C","Boards":{"Board":{"@name":"病毒清洗系统","@reason":"","@status":"normal","CpuUsage":"180","DiskUsage":"27/1","Interfaces":{"@inusenum":"1","@num":"1","Interface":{"@admin":"","@bandwidth":"","@gateway":"","@ip":"","@mac":"","@mask":"","@name":"","@speed":"","@status":""}},"MemUsage":"6421/254"}},"Software":{"CpuUsage":"180","CurrentUserName":"admin","DiskUsage":"27","MemUsage":"6421","Modules":{"Module":[{"@name":"MongoDB","@reason":"","@status":"normal","@version":"4.2.23"},{"@name":"Redis","@reason":"","@status":"normal","@version":"7.2.5"}]}}}}}},"XMLName":{"Local":"","Space":""}}]}
```

## 查看 pod 监听的端口

```bash
kubectl exec -it node-7b9f8bcd9-4xk6m -n sdsp -- /bin/sh -c "ss -tunlp"
```

## 新增 pod 的 netport

```bash
kubectl expose pod node-5ccfc78679-b2sbj -n sdsp --name=node-rpc-8282 \
  --type=NodePort --port=8282 --target-port=8282
```

# mongo：

## 进入 mongo：

```bash
mongo -u admin -p 'Cloud@talent123!@#'
```

### 切换数据库:

```bash
use 数据库名
```

### 查看集合数据：

```bash
db.集合名称.find({"_id":ObjectId("68dba608b9215cd46fb12bf4")}).limit(10)
```

### 统计集合数据：

```bash
db.file_record.countDocuments({})
```

### 根据字段统计集合数据：

```bash
rs0:PRIMARY> db.file_record.aggregate([
...   {
...     $group: {
...       _id: {
...         clean_task_id: "$clean_task_id",
...         channel_id: "$channel_id"
...       },
...       count: { $sum: 1 }
...     }
...   },
...   { $sort: { count: -1 } }
... ])
{ "_id" : { "clean_task_id" : "68fca7354dd5f8975b85b48e", "channel_id" : NumberLong(8) }, "count" : 101 }
{ "_id" : { "clean_task_id" : "68fcc007606450bff08f3c08", "channel_id" : NumberLong(1) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "68fca7354dd5f8975b85b48e", "channel_id" : NumberLong(2) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "690025db4dd5f8975b85b2d6", "channel_id" : NumberLong(3) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "68fca2124dd5f8975b85b3be", "channel_id" : NumberLong(6) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "68fca7354dd5f8975b85b48e", "channel_id" : NumberLong(7) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "68fca7354dd5f8975b85b48e", "channel_id" : NumberLong(5) }, "count" : 100 }
{ "_id" : { "clean_task_id" : "68fca1924dd5f8975b85b33e", "channel_id" : NumberLong(4) }, "count" : 10 }
{ "_id" : { "clean_task_id" : "68fca4064dd5f8975b85b426", "channel_id" : NumberLong(7) }, "count" : 1 }
{ "_id" : { "clean_task_id" : "68fca1d74dd5f8975b85b356", "channel_id" : NumberLong(5) }, "count" : 1 }
```
