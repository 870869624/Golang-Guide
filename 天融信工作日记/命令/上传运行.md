在本机打包完成镜像后，有几种方法可以将镜像放到客户机上替换cleansvc服务。以下是详细的步骤：

## 方法1：使用Docker Save/Load（推荐）

### 步骤1：在本机保存镜像为文件

```bash
# 保存镜像为tar文件
docker save -o cleansvc-new.tar cleansvc:latest

# 或者指定版本
docker save -o cleansvc-new.tar cleansvc:$(VERSION)

# 检查文件大小
ls -lh cleansvc-new.tar
```

### 步骤2：传输文件到客户机

```bash
# 使用scp传输（如果客户机可ssh访问）
scp cleansvc-new.tar user@customer-machine:/tmp/

# 或者使用U盘、移动硬盘等物理介质拷贝
```

### 步骤3：在客户机加载镜像

```bash
# 登录客户机，加载镜像
docker load -i /tmp/cleansvc-new.tar

# 验证镜像已加载
docker images | grep cleansvc
```

### 步骤4：替换K8s服务

```bash
# 方法A：滚动重启Deployment（推荐）
kubectl rollout restart deployment cleansvc -n sdsp

# 方法B：直接更新镜像
kubectl set image deployment/cleansvc cleansvc=cleansvc:latest -n sdsp

# 方法C：如果知道具体的容器名称
kubectl set image deployment/cleansvc container-name=cleansvc:latest -n sdsp
```

## 方法2：使用私有Docker Registry

如果客户环境有内网Docker registry：

### 步骤1：配置和推送镜像

```bash
# 登录私有registry（如果有认证）
docker login internal-registry.company.com

# 重新tag镜像
docker tag cleansvc:latest internal-registry.company.com/sdsp/cleansvc:latest

# 推送镜像
docker push internal-registry.company.com/sdsp/cleansvc:latest
```

### 步骤2：在客户机更新服务

```bash
# 更新Deployment使用新镜像
kubectl set image deployment/cleansvc cleansvc=internal-registry.company.com/sdsp/cleansvc:latest -n sdsp
```

## 方法3：完整的操作流程

### 准备工作

```bash
# 1. 在本机确认镜像已构建成功
docker images | grep cleansvc

# 2. 查看当前的K8s服务状态（在客户机执行）
kubectl get pods -n sdsp -o wide
kubectl get deployment cleansvc -n sdsp -o yaml | grep image
```

### 传输和部署

```bash
# 3. 保存并传输镜像
docker save -o cleansvc-$(date +%Y%m%d).tar cleansvc:latest
# 传输到客户机...

# 4. 在客户机加载镜像
docker load -i cleansvc-$(date +%Y%m%d).tar

# 5. 备份当前版本（可选）
kubectl get deployment cleansvc -n sdsp -o yaml > cleansvc-backup-$(date +%Y%m%d).yaml

# 6. 更新服务
kubectl rollout restart deployment cleansvc -n sdsp
```

### 验证部署

```bash
# 7. 查看更新状态
kubectl rollout status deployment/cleansvc -n sdsp

# 8. 查看新Pod状态
kubectl get pods -n sdsp -l app=cleansvc

# 9. 查看日志确认新版本正常运行
kubectl logs -f deployment/cleansvc -n sdsp

# 10. 验证服务功能
# 根据你的应用进行功能验证
```

## 方法4：使用K8s的镜像拉取策略

如果客户机可以访问某个共享存储：

### 步骤1：修改Deployment使用本地镜像

```bash
# 编辑Deployment
kubectl edit deployment cleansvc -n sdsp
```

修改镜像拉取策略：

```yaml
spec:
  template:
    spec:
      containers:
      - name: cleansvc
        image: cleansvc:latest  # 使用本地镜像
        imagePullPolicy: Never  # 重要：不尝试从registry拉取
```

## 详细的操作示例

### 完整示例脚本

```bash
#!/bin/bash
# deploy-cleansvc.sh

# 变量定义
IMAGE_NAME="cleansvc"
IMAGE_TAG="latest"
NAMESPACE="sdsp"
DEPLOYMENT_NAME="cleansvc"

echo "=== 开始部署cleansvc新版本 ==="

# 1. 保存镜像
echo "1. 保存Docker镜像..."
docker save -o ${IMAGE_NAME}-new.tar ${IMAGE_NAME}:${IMAGE_TAG}

# 2. 传输到客户机（这里需要你根据实际情况完成）
echo "2. 请手动将 ${IMAGE_NAME}-new.tar 传输到客户机"

# 在客户机上执行以下步骤：
cat << EOF

=== 在客户机上执行以下命令 ===

# 3. 加载镜像
docker load -i ${IMAGE_NAME}-new.tar

# 4. 验证镜像
docker images | grep ${IMAGE_NAME}

# 5. 备份当前部署
kubectl get deployment ${DEPLOYMENT_NAME} -n ${NAMESPACE} -o yaml > ${DEPLOYMENT_NAME}-backup.yaml

# 6. 重启部署
kubectl rollout restart deployment ${DEPLOYMENT_NAME} -n ${NAMESPACE}

# 7. 等待部署完成
kubectl rollout status deployment/${DEPLOYMENT_NAME} -n ${NAMESPACE}

# 8. 验证新Pod
kubectl get pods -n ${NAMESPACE} -l app=${DEPLOYMENT_NAME}

# 9. 查看日志
kubectl logs -f deployment/${DEPLOYMENT_NAME} -n ${NAMESPACE}

EOF
```

## 注意事项

1. **版本管理**：建议使用有意义的版本标签，而不是总是用latest
2. **回滚准备**：更新前备份当前部署配置
3. **资源清理**：传输完成后删除临时tar文件以节省空间
4. **网络考虑**：如果镜像很大，考虑压缩或分卷传输

```bash
# 压缩镜像文件（如果很大）
gzip cleansvc-new.tar

# 在客户机解压
gunzip cleansvc-new.tar.gz
```

## 快速验证命令

部署完成后，使用这些命令验证：

```bash
# 查看所有相关Pod状态
kubectl get pods -n sdsp

# 查看cleansvc的详细状态
kubectl describe deployment cleansvc -n sdsp

# 查看事件日志
kubectl get events -n sdsp --sort-by=.metadata.creationTimestamp

# 检查服务端点
kubectl get endpoints -n sdsp
```

推荐使用**方法1（Docker Save/Load）**，这是最可靠且在完全离线环境下工作的方案。
